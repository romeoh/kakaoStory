<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>  
<title>funnyApp</title>
<link rel="stylesheet" type="text/css" href="../css/style.css">

<style type="text/css">
* {-webkit-user-select:none;}
body {margin:0; background:#b8e400}
#adTop {width:100%; height:50px}
.bg {position:relative; background:#eee; background:url(../imgFinger/bg.png) no-repeat 50% 0; padding-top:20px;}
.wrapper {position:relative; width:320px; height:380px; margin:0 auto; overflow:hidden}
.infoBox {position:relative; width:320px; margin:0 auto; top:-20px;}
#pointer {position:absolute; width:75px; height:75px; position:absolute; bottom:43px; left:131px; background:url(../imgFinger/circle.png) no-repeat; z-index:100; display:none; opacity:0}
.frame {position:absolute; width:320px; height:380px; background:url(../imgFinger/frame.png) no-repeat; z-index:90}
#knife {position:absolute; width:149px; height:296px; left:93px; top:-195px; background:url(../imgFinger/knife.png) no-repeat; z-index:80}	/*12px ~ -195px*/

#popCount {position:absolute; background:url(../imgFinger/popCount.png) no-repeat; width:129px; height:77px; top:110px; left:100px; z-index:120; color:#ffb600; font-size: 49px; text-align:center; padding-top:25px; display:none;}
#popup {position:absolute; background:url(../imgFinger/popbg.png) no-repeat; width:305px; height:206px; top:80px; left:10px; z-index:120; color:#ffb600;  text-align:center; display:none;}
#popup .info {font-size: 18px; padding-top: 60px; display:}
#popup .result {position:absolute; background:url(../imgFinger/popAc.png) no-repeat; width:156px; height:110px; top:16px; left:70px; font-size: 39px; padding-top: 30px; display:none;}
#popup .share {width:170px; height:110px; top:16px; left:70px; font-size: 18px; padding:50px 0 0 70px; display:none;}
#popup .share p {margin:3px;}
#score {position:absolute; z-index:300; color:#fff; left:20px; font-size:16px}
#combo {position:absolute; z-index:300; color:#048eb9; right:20px; font-size:16px}
</style>
</head>

<body style="">

<div id="adTop"></div>

<div class="bg">
	<div class="infoBox">
		<div id="score">score: 0</div>
		<div id="combo"></div>
	</div>
	<div class="wrapper">
		<div id="popup">
			<p class="info">날이 떨어지면 <br>손가락을 피하세요.</p>
			<p class="result"></p>
			<div class="share">
				<p id="resultScore"></p>
				<p id="btnShare"><img src="../imgFinger/btn.png" alt="카스로 공유"></p>
				<p id="btnReply"><img src="../imgFinger/btnReply.png" alt="다시하기"></p>
			</div>
		</div>
		<div id="popCount"></div>
		<div id="pointer"></div>
		<div class="frame"></div>
		<div id="knife"></div>
	</div>
</div>

<!--div style="border:1px solid red; width:100%; height:50px; position:fixed; bottom:0" id="adBottom"-->

</div>

<script type="text/javascript" src="../js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../js/mpui.js"></script>
<script type="text/javascript" src="../js/kakao.link.js"></script>
<!--script type="text/javascript" src="../js/finger.js"></script-->

<script type="text/javascript">
var  nowDeg = 0
	,derection = 1
	,pointId = null
	,countId = null
	,thisCount = 4
	,score = 0
	,combo = 0
	,intro0 = intro1 = intro2 = intro3 = intro4 = intro5 = null
	,actionId = null
	,successRage = false
	,successResult = false
	,actionId0 = actionId1 = actionId2 = null

window.addEventListener('load', ready, false);

function ready(){
	window.scrollTo(0, 0);
	$('#btnReply').on('click', function(){
		gameReady();
		hidePop();
		pointPlay();
		resetScore();
	})
	$('#btnShare').on('click', function(){
		var postMsg = ''
		postMsg += '[손가락 루이16세]\n\n';
		postMsg += '최고점수: ' + score + '점 획득!!\n';
		postMsg += combo + ' 콤보를 달성했습니다.\n\n';
		
		postMsg += '다시 도전하기 http://goo.gl/u3vjV\n';
		
		urlMsg = {
			title: '[웹게임] 손가락 루이16세',
			desc: '최고점수: ' + score + '점, ' + combo + ' 콤보 달성',
			imageurl: ['http://romeoh.github.io/kakaoStory/img/'],
			type:'article'
		}
		console.log(postMsg, urlMsg)

		kakao.link("story").send({   
	        post : postMsg,
	        appid : 'funnyApp',
			appver : '1.0',
			appname : '손가락 루이 16세',
			urlinfo : JSON.stringify(urlMsg)
	    });
	})
	
	introGame();
}

/*
 * 인트로
 */
function introGame(){
	intro0 = setTimeout(knifePlay, 500, '.3');
	intro1 = setTimeout(knifeReset, 1400);
	intro2 = setTimeout(viewPopInfo, 1700);
	intro3 = setTimeout(hidePop, 3700);
	intro4 = setTimeout(pointPlay, 3700);
	intro5 = setTimeout(gameReady, 3700);
}

/*
 * 인트로 취소
 */
function introKill(){
	clearTimeout(intro0);
	clearTimeout(intro1);
	clearTimeout(intro2);
	clearTimeout(intro3);
	clearTimeout(intro4);
	clearTimeout(intro5);
	intro0 = intro1 = intro2 = intro3 = intro4 = intro5 = null;
	knifeReset('0.1');
	hidePop();
	pointPlay();
	gameReady();
}

/*
 * 게임초기화
 */
function resetGame(){
	score = 0;
	combo = 0;
	M('#score').text('score: ' + score);
	M('#combo').text('');
	successRage = false;
}

/*
 * 게임 준비완료
 */
function gameReady(){
	$('#pointer').on('touchstart', gameStart);
}

function nextGame(flag){
	//console.log('nextGame', combo, flag)
	if (flag === 0 && combo >= 2) {
		console.log('공유하기')
		setTimeout(function(){
			viewPopShare();
			$('#pointer').off('touchstart');
			$('#pointer').off('touchend');
		}, 2000);
		return;
	} else if (flag === 1) {
		//console.log('성공')
	}
	
	setTimeout(function(){
		knifeReset();
		hidePop();
		pointPlay();
		if (flag === 0) {
			resetScore();
		}
		//gameReady();
	}, 2000)
}

function gameStart(){
	successResult = null
	$('#pointer').off('touchend');
	$('#pointer').on('touchend', gameEnd);
	countPlay();
	pointPause();
	actionId0 = setTimeout(action, 4000);	//카운트 4초후 action
}

// 랜덤시간후 knifePlay
function action(){
	actionId1 = setTimeout(function(){
		successRage = true;
		//knifePlay('.25', actionResult)
		knifePlay('.8', actionResult);
	}, getRan());
}

// knifePlay후 결과반환
function actionResult(){
	successRage = false;

	// 카운트 만료
	if (thisCount == 1) {
		gameStop();
		resultTxt = '실패';
		actionId2 = setTimeout(viewPopResult, 100, resultTxt);	// 성공유무 팝업보기
		nextGame(0);
		console.log('빠름 실패')
	} else if (thisCount == 0) {
		//console.log('카운트만료')
		if (successResult === true) {
			resultTxt = '성공';
			actionId2 = setTimeout(viewPopResult, 500, resultTxt);	// 성공유무 팝업보기
			setScore();
			nextGame(1);
			console.log('성공')
		} else if (successResult === null) {
			resultTxt = '실패';
			actionId2 = setTimeout(viewPopResult, 100, resultTxt);	// 성공유무 팝업보기
			$('#pointer').off('touchend');
			nextGame(0);
			console.log('늦었음 실패')
		} else {
			gameStop();
			resultTxt = '실패';
			actionId2 = setTimeout(viewPopResult, 100, resultTxt);	// 성공유무 팝업보기
			nextGame(0);
			console.log('대기중 실패')
		}
	} else {
		resultTxt = '실패';
		gameStop();
		countKill();
		pointPlay();
		console.log('무시')
	}

	//console.log('최종결과: ',resultTxt)
}

// 터치종료
function gameEnd(){
	if (successRage) {
		successResult = true;
	} else {
		successResult = false;
	}

	actionResult()
}

// 게임 강제종료
function gameStop() {
	clearTimeout(actionId0)
	clearTimeout(actionId1)
	clearTimeout(actionId2)
	actionId0 = actionId1 = actionId2 = null
}

// 다시하기
function replay(){
	knifeReset();
	hidePop();
}

/*
 * 스코어/콤보
 */
function setScore(){
	score = score + ranScore();
	combo++;
	M('#score').text('score: ' + score);
	M('#combo').text(combo + ' combo');
}

function resetScore(){
	score = 0
	combo = 0
	M('#score').text('score: 0');
	M('#combo').text('');
}

/*
 * 카운트제어
 */
function countPlay(){
	thisCount = 4;
	killPop();
	M('#popCount').css('display', 'block')
	countAnimate()
	countId = setInterval(countAnimate, 1000)
}

function countAnimate() {
	thisCount--;
	if (thisCount == 0) {
		countTxt = 'GO'
		clearInterval(countId)
		countId = null
		setTimeout(countKill, 1000)
	} else {
		countTxt = thisCount
	}
	M('#popCount')
		.css('scale', '0.1')
		.text(countTxt)
		.animate({
			 'scale': '1'
			,'time': '.3s'
		})
}

function countKill(){
	if (countId != null) {
		clearInterval(countId);
		countId = null
	}
	M('#popCount').css('display', 'none')
	//pointPlay();
}

/*
 * 안내 팝업
 */
function viewPopInfo(){
	killPop();
	M('#popup .info')
		.css('display', 'block')
	M('#popup')
		.css('display', 'block')
		.css('scale', '.1')
		.animate({
			 'scale': '1'
			,'time': '.3s'
		})
}

/*
 * 결과팝업
 */
function viewPopResult(result){
	killPop();
	if (!result) {
		result = '성공'
	}
	M('#popup .result')
		.css('display', 'block')
		.text(result)
	M('#popup')
		.css('display', 'block')
		.css('scale', '.1')
		.animate({
			 'scale': '1'
			,'time': '.3s'
		})
}

/*
 * 공유팝업
 */
function viewPopShare(){
	killPop();
	M('#resultScore').text(M.toCurrency(score) + '점 / ' + combo + '콤보')
	M('#popup .share')
		.css('display', 'block')
	M('#popup')
		.css('display', 'block')
		.css('scale', '.1')
		.animate({
			 'scale': '1'
			,'time': '.3s'
		})
}

/*
 * 팝업 해제
 */
function hidePop(){
	M('#popup')
		.animate({
			 'scale': '0'
			,'time': '.3s'
		}, function(){
			//killPop()
		})
}

function killPop(){
	countKill();
	M('#popup .info').css('display', 'none')
	M('#popup .result').css('display', 'none')
	M('#popup .share').css('display', 'none')
	M('#popup').css('display', 'none')
}

/*
 * knife 제어
 */
function knifePlay(speed, cb){
	if (!speed) {
		speed = '1'
	}
	M('#knife').animate({
		 'top':'12px'
		,'time': speed + 's' //.25s
	}, function(){
		if (typeof cb == 'function') {
			if (!successResult) {
				cb();
			}
		}
	})
}

function knifeReset(speed, cb){
	if (!speed) {
		speed = '2'
	}
	M('#knife').animate({
		 'top':'-195px'
		,'time': speed + 's'
	}, function(){
		if (typeof cb == 'function') {
			cb();
		}
	})
}

/*
 * 포인트 동작제어
 */
function pointPlay() {
	$('#pointer')
		.css('display', 'block')
		.animate({
			 'opacity': '1'
			,'time':'.3s'
		})
	if (pointId != null) {
		clearInterval(pointId)
		pointId = null;
	}
	pointId = setInterval(pointAnimate, 80);
}

function pointAnimate(){
	$('#pointer').css({'transform': 'rotate('+nowDeg+'deg)'});
	if (nowDeg >= 90) {
		derection = -1
	} else if (nowDeg <= 0) {
		derection = 1
	}
	if (derection == 1) {
		nowDeg = nowDeg + 1
	} else {
		nowDeg = nowDeg - 1
	}
}

function pointStop(){
	$('#pointer')
		.animate({
			 'opacity': '.1'
			,'time':'.3s'
		}, function(){
			$(this).css('display', 'none');
		})

	clearInterval(pointId);
	pointId = null;
}

function pointPause(){
	clearInterval(pointId);
	pointId = null;
}


/*
 * 렌덤시간 가져옴
 */
function getRan(){
	return Math.floor(Math.random() * 2000)
}

function ranScore(){
	return Math.floor(Math.random() * 50) + 100
}


</script>
</body>
</html>






















